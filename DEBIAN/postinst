#!/bin/bash

LONG_DATE=`date +%Y%m%d%H%M%S`

/etc/init.d/tomcat6 stop

##### Copy the jar file into the correct lib directory for D1 Authorization

cp /usr/share/dataone-cn-solr/d1_solr_extensions.jar /usr/share/solr/WEB-INF/lib

##### Change the web.xml to include the D1 authorization filter
SOLR_AUTHORIZATION_FILTER="\n\
\t<filter>\n\
\t\t<filter-name>D1SolrAuthorizationFilter<\/filter-name>\n\
\t\t<filter-class>org.dataone.solr.servlet.SessionAuthorizationFilter<\/filter-class>\n\
\t<\/filter>\n\
\t<filter-mapping>\n\
\t\t<filter-name>D1SolrAuthorizationFilter<\/filter-name>\n\
\t\t<url-pattern>\/d1-cn-log\/select</url-pattern>\n\
\t\t<url-pattern>\/d1-cn-log/select\/</url-pattern>\n\
\t\t<url-pattern>\/d1-cn-log/select\/*</url-pattern>\n\
\t<\/filter-mapping>\n"

CONTAINS_DATAONE_FILTER=$(egrep 'D1SolrAuthorizationFilter' /usr/share/solr/WEB-INF/web.xml)
if [ "${CONTAINS_DATAONE_FILTER}" == "" ]; then

        # this seems a bit fragile to do with sed, maybe perl would offer a better alternative if the below substitution causes troubles
        sed -i.bak --regexp-extended "s/(<web-app>)/\1${SOLR_AUTHORIZATION_FILTER}/;" /usr/share/solr/WEB-INF/web.xml
else
        echo "DataONE Solr Authorization Filter Already added"
fi

##### Provide tomcat web app context for solr cores
cp /usr/share/dataone-cn-solr/debian/d1-cn-index.xml /etc/tomcat6/Catalina/localhost/d1-cn-index.xml
cp /usr/share/dataone-cn-solr/debian/d1-cn-log.xml /etc/tomcat6/Catalina/localhost/d1-cn-log.xml

chown -R tomcat6.tomcat6 /etc/tomcat6/Catalina/localhost/d1-cn-index.xml
chown -R tomcat6.tomcat6 /etc/tomcat6/Catalina/localhost/d1-cn-log.xml

####### Provide multi-core solr configuration file.
mv /usr/share/solr/solr.xml /usr/share/solr/solr.xml.bak
cp /usr/share/dataone-cn-solr/debian/multicore-solr.xml /usr/share/solr/solr.xml

if [ ! -d /usr/share/solr/d1-cn-index ]
then
	mkdir /usr/share/solr/d1-cn-index
	cp -R /etc/solr/conf /usr/share/solr/d1-cn-index/
fi
cp /usr/share/dataone-cn-solr/debian/d1-index-solrconfig.xml /usr/share/solr/d1-cn-index/conf/solrconfig.xml

if [ ! -d /usr/share/solr/d1-cn-log ]
then
	mkdir /usr/share/solr/d1-cn-log
	cp -R /etc/solr/conf /usr/share/solr/d1-cn-log/
fi
cp /usr/share/dataone-cn-solr/debian/d1-log-solrconfig.xml /usr/share/solr/d1-cn-log/conf/solrconfig.xml


##### Provide tomcat policy file for solr
cp /usr/share/dataone-cn-solr/debian/53solr.policy /etc/tomcat6/policy.d/
chown -R tomcat6.tomcat6 /etc/tomcat6/policy.d/53solr.policy

chown -R tomcat6.tomcat6 /etc/solr
chown -R tomcat6.tomcat6 /usr/share/solr
chown -R tomcat6.tomcat6 /var/lib/solr

######## Update logging solr index schema

mv /usr/share/solr/d1-cn-log/conf/schema.xml /usr/share/solr/d1-cn-log/schema.xml.bak
cp /usr/share/dataone-cn-solr/debian/log-solr-schema.xml /usr/share/solr/d1-cn-log/conf/schema.xml
chown -R tomcat6.tomcat6 /usr/share/solr/d1-cn-index/conf/schema.xml

####get rid of the examples xslt and add in the d1log.xsl
rm /usr/share/solr/d1-cn-log/conf/xslt/example*.*
cp /usr/share/dataone-cn-solr/debian/d1log.xsl /usr/share/solr/d1-cn-log/conf/xslt/

###### Configure Apache
/etc/init.d/apache2 stop

cp usr/share/dataone-cn-solr/debian/solr_jk.conf /etc/apache2/jk_mount/

cp usr/share/dataone-cn-solr/debian/rewrite_cnlog /etc/apache2/conf.d/
cp usr/share/dataone-cn-solr/debian/rewrite_cnsearch /etc/apache2/conf.d/
cp usr/share/dataone-cn-solr/debian/proxy /etc/apache2/conf.d/

##### Start apache and tomcat
/etc/init.d/apache2 start
/etc/init.d/tomcat6 start

## Update DateONE Version Info Doc
java -jar /usr/share/dataone-cn-version-tool/dataone-cn-version-tool.jar -F/usr/share/dataone-cn-version-tool/version-tool.properties -html > /var/www/cn-version.html
