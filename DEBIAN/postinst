#!/bin/bash

LONG_DATE=`date +%Y%m%d%H%M%S`

/etc/init.d/tomcat6 stop

##### Provide tomcat web app context for solr cores
cp /usr/share/dataone-cn-solr/debian/d1-cn-index.xml /etc/tomcat6/Catalina/localhost/d1-cn-index.xml
cp /usr/share/dataone-cn-solr/debian/d1-cn-log.xml /etc/tomcat6/Catalina/localhost/d1-cn-log.xml

chown -R tomcat6.tomcat6 /etc/tomcat6/Catalina/localhost/d1-cn-index.xml
chown -R tomcat6.tomcat6 /etc/tomcat6/Catalina/localhost/d1-cn-log.xml

####### Provide multi-core solr configuration file.
mv /usr/share/solr/solr.xml /usr/share/solr/solr.xml.bak
cp /usr/share/dataone-cn-solr/debian/multicore-solr.xml /usr/share/solr/solr.xml

###### Create core home dir
mkdir /usr/share/solr/d1-cn-index
mkdir /usr/share/solr/d1-cn-log

###### Provide default config:
cp -R /etc/solr/conf /usr/share/solr/d1-cn-index/
cp -R /etc/solr/conf /usr/share/solr/d1-cn-log/

###### Provide modified solrconfig.xml with modified data dir path for each core
cp /usr/share/dataone-cn-solr/debian/d1-index-solrconfig.xml /usr/share/solr/d1-cn-index/conf/solrconfig.xml
cp /usr/share/dataone-cn-solr/debian/d1-log-solrconfig.xml /usr/share/solr/d1-cn-log/conf/solrconfig.xml

chown -R tomcat6.tomcat6 /etc/solr
chown -R tomcat6.tomcat6 /usr/share/solr
chown -R tomcat6.tomcat6 /var/lib/solr

######## Update logging solr index schema

mv /usr/share/solr/d1-cn-log/conf/schema.xml /usr/share/solr/d1-cn-log/schema.xml.bak
cp /usr/share/dataone-cn-solr/debian/log-solr-schema.xml /usr/share/solr/d1-cn-log/conf/schema.xml
chown -R tomcat6.tomcat6 /usr/share/solr/d1-cn-index/conf/schema.xml

####get rid of the examples xslt and add in the d1log.xsl
rm /usr/share/solr/d1-cn-log/conf/xslt/example*.*
cp /usr/share/dataone-cn-solr/debian/d1log.xsl /usr/share/solr/d1-cn-log/conf/xslt/

###### Configure Apache
/etc/init.d/apache2 stop

## disable and then re-enable mod proxy & mod proxy http to pick up changes
log "Refreshing Proxy"

a2dismod proxy_http
a2dismod proxy

a2enmod proxy
a2enmod proxy_http

## disable and then re-enable mod rewrite  to pick up changes
log "Refreshing Rewrite"
a2dismod rewrite
a2enmod rewrite

cp usr/share/dataone-cn-solr/debian/solr_jk.conf /etc/apache2/jk_mount/

cp usr/share/dataone-cn-solr/debian/rewrite_cnlog /etc/apache2/conf.d/
cp usr/share/dataone-cn-solr/debian/proxy /etc/apache2/conf.d/

##### Start apache and tomcat
/etc/init.d/apache2 start
/etc/init.d/tomcat6 start
